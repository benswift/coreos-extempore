#cloud-config
coreos:
  etcd:
    discovery: https://discovery.etcd.io/30857a03766a605d6077b38beda84c5e
    addr: $public_ipv4:4001
    peer-addr: $public_ipv4:7001
  fleet:
    public-ip: $public_ipv4
  units:
  - name: etcd.service
    command: start
  - name: fleet.socket
    command: start
    content: |
      [Socket]
      # Talk to the API over a Unix domain socket (default)
      #ListenStream=/var/run/fleet.sock
      # Talk to the API over an exposed port, uncomment to enable and choose a port
      ListenStream=8080
      Service=fleet.service

      [Install]
      WantedBy=sockets.target

      [X-Fleet]
      Global=true
  - name: fleet.service
    command: start
  - name: extempore.service
    command: start
    content: |
      [Unit]
      Description=Extempore
      After=docker.service
      Requires=docker.service

      [Service]
      TimeoutStartSec=0
      ExecStartPre=-/usr/bin/docker kill benswift/extempore
      ExecStartPre=-/usr/bin/docker pull benswift/extempore
      ExecStart=/usr/bin/docker run --rm -p 7099:7099 -p 7098:7098 --privileged benswift/extempore --nodevice
      ExecStop=/usr/bin/docker stop benswift/extempore

      [X-Fleet]
      Global=true

# Local Variables:
# mode: conf
# End:
